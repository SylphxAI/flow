# 2026-02-08

## Memory Migration

- Migrated from single `CLAUDE.md` to two-layer memory system:
  - `MEMORY.md` — Curated long-term memory (architecture, decisions, patterns)
  - `memory/YYYY-MM-DD.md` — Daily logs (append-only)
- `CLAUDE.md` now contains only quick-reference commands and pointers

## PID-based Session Management Redesign

Replaced state-flag session tracking (`cleanupRequired`, `status`, `refCount`, `activePids`) with PID-based ground truth.

### Critical Bug Fixed
- Old: `endSession()` marked `cleanupRequired=false` and deleted session file BEFORE `restoreBackup()` ran. If process died between these ops, system could never recover — orphan detection required `cleanupRequired=true`, but file was already gone.
- New: `backup.json` deleted AFTER restore succeeds (via `finalizeSessionCleanup()`). Orphan detection checks for `backup.json` existence + no alive PIDs.

### Storage Structure Change
```
Old: ~/.sylphx-flow/sessions/<hash>.json  (single file with state flags)
New: ~/.sylphx-flow/sessions/<hash>/
       backup.json       (backup reference — exists = workspace modified)
       pids/
         <pid>.json      (per-process lock file)
```

### API Changes
- `startSession()` → `acquireSession()` (atomic `mkdir(pids/)` for first-session detection)
- `endSession()` → `releaseSession()` (PID liveness check via `kill(pid,0)`)
- `recoverSession()` → `finalizeSessionCleanup()` (called AFTER restore)
- `getActiveSession()` → `getBackupRef()` + `isSessionActive()`
- `Session` interface → `PidLock` + `BackupRef` interfaces

### Other Changes
- Removed SIGINT handler from cleanup-handler (child handles Ctrl+C)
- Added SIGINT suppression in execute-v2.ts around child spawn
- Made backup-manager `restoreBackup()` atomic (copy→temp, rm, rename)
- Fixed claude-code `applySettings` return value (count: 2 for both hooks)
- Added legacy session file migration in cleanup-handler
- Fixed `isPidAlive()` to handle `EPERM` (process exists, different user)

### Challenge Round 1 — Self-Critique Fixes
- Extracted `restoreAndFinalize()` helper in cleanup-handler (was duplicated 3x)
- Renamed `scanAlivePids` → `scanAndCleanPids` (honest about side effects)
- Corrupt legacy session files moved to `.corrupt` suffix instead of silently deleted
- Documented TOCTOU window in `releaseSession()` with rationale for accepting it

### Challenge Round 2 — Deep Audit Fixes
- Fixed TOCTOU race in `tryJoinExistingSession()`: verify backupRef from acquireSession return (not separate getBackupRef), release PID if session was cleaned between check and acquire
- Added `cleanupOrphanedRestores()` to BackupManager: detects orphaned `.flow-restore-*` temp dirs from interrupted restores, auto-recovers by renaming temp into place if config dir is missing
- Added EXDEV cross-filesystem fallback in `restoreBackup()`: if `fs.rename()` fails with EXDEV, falls back to copy+delete
